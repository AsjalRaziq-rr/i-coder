<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor with AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #fff; height: 100vh; overflow: hidden; }
        
        .container { display: flex; height: 100vh; }
        .editor-panel { flex: 1; display: flex; flex-direction: column; }
        .toolbar { background: #2d2d30; padding: 10px; border-bottom: 1px solid #3e3e42; }
        .file-tabs { display: flex; gap: 5px; }
        .tab { background: #3c3c3c; padding: 8px 15px; border-radius: 4px 4px 0 0; cursor: pointer; border: 1px solid #555; }
        .tab.active { background: #1e1e1e; border-bottom: 1px solid #1e1e1e; }
        
        .editor-container { flex: 1; position: relative; }
        .CodeMirror { height: 100%; font-size: 14px; }
        
        .terminal-toggle { position: fixed; bottom: 20px; right: 20px; background: #007acc; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; z-index: 1000; }
        .chat-toggle { position: fixed; bottom: 20px; right: 80px; background: #28a745; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; z-index: 1000; }
        
        .terminal-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 0; background: #1a1a1a; border-top: 1px solid #3e3e42; transition: height 0.3s ease; overflow: hidden; z-index: 998; }
        .terminal-panel.open { height: 40vh; }
        
        .chat-panel { position: fixed; bottom: 0; right: 0; width: 400px; height: 0; background: #252526; border-left: 1px solid #3e3e42; transition: height 0.3s ease; overflow: hidden; z-index: 999; }
        .chat-panel.open { height: 60vh; }
        
        .terminal-header { background: #2d2d30; padding: 10px; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center; }
        .terminal-content { flex: 1; padding: 10px; overflow-y: auto; max-height: calc(40vh - 100px); font-family: 'Courier New', monospace; color: #00ff00; }
        .terminal-input { display: flex; padding: 10px; border-top: 1px solid #3e3e42; }
        .terminal-input input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: #00ff00; padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; }
        .terminal-input button { background: #007acc; color: white; border: none; padding: 8px 15px; margin-left: 5px; border-radius: 4px; cursor: pointer; }
        .webcontainer-frame { width: 100%; height: 300px; border: 1px solid #3e3e42; border-radius: 4px; margin-top: 10px; display: none; }
        
        .chat-header { background: #2d2d30; padding: 10px; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center; }
        .model-selector { background: #3c3c3c; border: 1px solid #555; color: white; padding: 5px; border-radius: 3px; margin-left: 10px; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; max-height: calc(60vh - 100px); }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .message.user { background: #0e639c; margin-left: 20px; }
        .message.ai { background: #1a1a1a; margin-right: 20px; }
        
        .chat-input { display: flex; padding: 10px; border-top: 1px solid #3e3e42; }
        .chat-input input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        .chat-input button { background: #007acc; color: white; border: none; padding: 8px 15px; margin-left: 5px; border-radius: 4px; cursor: pointer; }
        
        .file-explorer { width: 250px; background: #252526; border-right: 1px solid #3e3e42; padding: 10px; overflow-y: auto; }
        .file-item { padding: 5px; cursor: pointer; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .file-item:hover { background: #2a2d2e; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .delete-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="file-explorer">
            <h3>Files</h3>
            <div id="fileList"></div>
            <button onclick="createFile()" style="margin-top: 10px; background: #007acc; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">New File</button>
            <button onclick="previewApp()" style="margin-top: 5px; background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; width: 100%;">üîç Preview App</button>
        </div>
        
        <div class="editor-panel">
            <div class="toolbar">
                <div class="file-tabs" id="fileTabs"></div>
            </div>
            <div class="editor-container">
                <textarea id="editor"></textarea>
            </div>
        </div>
    </div>
    
    <button class="terminal-toggle" onclick="toggleTerminal()">‚ö°</button>
    <button class="chat-toggle" onclick="toggleChat()">üí¨</button>
    
    <div class="terminal-panel" id="terminalPanel">
        <div class="terminal-header">
            <span>Terminal</span>
            <button onclick="toggleTerminal()" style="background: none; border: none; color: white; cursor: pointer;">‚úï</button>
        </div>
        <div class="terminal-content" id="terminalOutput">Welcome to Terminal. Type commands and press Enter to execute.

</div>
        <div class="terminal-input">
            <span style="color: #00ff00; margin-right: 10px;">$</span>
            <input type="text" id="terminalInput" placeholder="Enter command..." onkeypress="handleTerminalKeypress(event)">
            <button onclick="executeTerminalCommand()">Run</button>
        </div>
    </div>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>AI Assistant</span>
            <div>
                <select id="modelSelector" class="model-selector" onchange="switchModel()">
                    <option value="groq">Groq (Llama)</option>
                    <option value="codestral">Codestral</option>
                </select>
                <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer; margin-left: 10px;">‚úï</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask AI to help with code..." onkeypress="handleChatKeypress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let editor;
        let currentFile = null;
        let files = {};
        
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            lineNumbers: true,
            theme: 'default',
            mode: 'javascript',
            indentUnit: 2,
            tabSize: 2,
            indentWithTabs: false
        });
        
        // Terminal functionality
        function toggleTerminal() {
            const panel = document.getElementById('terminalPanel');
            panel.classList.toggle('open');
        }
        
        function handleTerminalKeypress(event) {
            if (event.key === 'Enter') {
                executeTerminalCommand();
            }
        }
        
        async function executeTerminalCommand() {
            const input = document.getElementById('terminalInput');
            const output = document.getElementById('terminalOutput');
            const command = input.value.trim();
            
            if (!command) return;
            
            output.textContent += `$ ${command}\n`;
            input.value = '';
            
            // Check if it's a dev server command
            const isDevServer = command.includes('npm start') || 
                               command.includes('http.server') || 
                               command.includes('serve') ||
                               command.includes('python -m http.server') ||
                               command.includes('python3 -m http.server');
            
            if (isDevServer) {
                try {
                    output.textContent += 'Starting dev server in WebContainer...\n';
                    
                    const { WebContainer } = await import('https://unpkg.com/@webcontainer/api@latest/dist/index.js');
                    
                    // Reuse existing instance or create new one
                    let webcontainer = window.webcontainerInstance;
                    if (!webcontainer) {
                        webcontainer = await WebContainer.boot();
                        window.webcontainerInstance = webcontainer;
                    }
                    
                    // Copy current files to WebContainer
                    const filesResponse = await fetch('/api/files');
                    const { files } = await filesResponse.json();
                    
                    // Mount files in WebContainer
                    const fileTree = {};
                    for (const file of files) {
                        if (file.type === 'file') {
                            const response = await fetch(`/api/files/${file.path}`);
                            const { content } = await response.json();
                            fileTree[file.path] = { file: { contents: content } };
                        }
                    }
                    
                    await webcontainer.mount(fileTree);
                    
                    // Start dev server
                    if (command.includes('npm start')) {
                        await webcontainer.spawn('npm', ['start']);
                    } else {
                        await webcontainer.spawn('python3', ['-m', 'http.server', '8000']);
                    }
                    
                    // Show WebContainer URL
                    webcontainer.on('server-ready', (port, url) => {
                        output.textContent += `Server running at: ${url}\n`;
                        output.textContent += `Click to open: ${url}\n`;
                        output.scrollTop = output.scrollHeight;
                    });
                    
                } catch (error) {
                    output.textContent += `WebContainer Error: ${error.message}\n`;
                    output.scrollTop = output.scrollHeight;
                }
            } else {
                // Regular server-side command
                try {
                    const response = await fetch('/api/terminal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command })
                    });
                    
                    const result = await response.text();
                    output.textContent += result + '\n';
                    output.scrollTop = output.scrollHeight;
                } catch (error) {
                    output.textContent += `Error: ${error.message}\n`;
                    output.scrollTop = output.scrollHeight;
                }
            }
        }
        
        // Model switching
        async function switchModel() {
            const selector = document.getElementById('modelSelector');
            const model = selector.value;
            
            try {
                await fetch('/api/switch-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model })
                });
                addMessage(`Switched to ${model.toUpperCase()} model`, 'ai');
            } catch (error) {
                addMessage(`Error switching model: ${error.message}`, 'ai');
            }
        }
        
        // Load current model on page load
        async function loadCurrentModel() {
            try {
                const response = await fetch('/api/current-model');
                const data = await response.json();
                document.getElementById('modelSelector').value = data.model;
            } catch (error) {
                console.error('Error loading current model:', error);
            }
        }
        
        // Chat functionality
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            panel.classList.toggle('open');
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        currentFile: currentFile,
                        fileContent: currentFile ? editor.getValue() : null,
                        files: Object.keys(files)
                    })
                });
                
                const result = await response.json();
                addMessage(result.response, 'ai');
                
                // Handle tool results
                if (result.fileUpdated) {
                    loadFile(result.fileUpdated);
                }
                if (result.filesChanged) {
                    loadFileList();
                }
            } catch (error) {
                addMessage('Error: ' + error.message, 'ai');
            }
        }
        
        function addMessage(text, type) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        // File management
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                displayFiles(data.files);
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }
        
        function displayFiles(fileList) {
            const container = document.getElementById('fileList');
            container.innerHTML = '';
            
            function renderFiles(files, indent = 0) {
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.style.paddingLeft = (indent * 15) + 'px';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = file.name;
                    nameSpan.onclick = () => {
                        if (file.type === 'file') {
                            loadFile(file.path);
                        }
                    };
                    
                    div.appendChild(nameSpan);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteFile(file.path);
                    };
                    div.appendChild(deleteBtn);
                    
                    container.appendChild(div);
                    
                    if (file.children) {
                        renderFiles(file.children, indent + 1);
                    }
                });
            }
            
            renderFiles(fileList);
        }
        
        async function deleteFile(filePath) {
            if (!confirm(`Delete ${filePath}?`)) return;
            
            try {
                await fetch(`/api/files/${filePath}`, { method: 'DELETE' });
                loadFileList();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }
        
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/api/files/${filePath}`);
                const data = await response.json();
                
                files[filePath] = data.content;
                currentFile = filePath;
                editor.setValue(data.content);
                
                // Update file mode based on extension
                const ext = filePath.split('.').pop();
                const mode = ext === 'py' ? 'python' : 'javascript';
                editor.setOption('mode', mode);
                
                updateTabs();
            } catch (error) {
                console.error('Error loading file:', error);
            }
        }
        
        async function saveFile() {
            if (!currentFile) return;
            
            const content = editor.getValue();
            files[currentFile] = content;
            
            try {
                await fetch('/api/files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePath: currentFile, content })
                });
            } catch (error) {
                console.error('Error saving file:', error);
            }
        }
        
        function createFile() {
            const name = prompt('File name:');
            if (name) {
                files[name] = '';
                currentFile = name;
                editor.setValue('');
                updateTabs();
                saveFile();
                loadFileList();
            }
        }
        
        function updateTabs() {
            const container = document.getElementById('fileTabs');
            container.innerHTML = '';
            
            Object.keys(files).forEach(filePath => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (filePath === currentFile ? ' active' : '');
                tab.textContent = filePath.split('/').pop();
                tab.onclick = () => loadFile(filePath);
                container.appendChild(tab);
            });
        }
        
        // Auto-save on change
        editor.on('change', () => {
            if (currentFile) {
                files[currentFile] = editor.getValue();
                setTimeout(saveFile, 1000);
            }
        });
        
        function previewApp() {
            // Look for index.html or first HTML file
            const htmlFile = Object.keys(files).find(f => f.endsWith('.html')) || 'index.html';
            const previewUrl = `/workspace/${htmlFile}`;
            window.open(previewUrl, '_blank');
        }
        
        // Initialize
        loadFileList();
        loadCurrentModel();
    </script>
</body>
</html>