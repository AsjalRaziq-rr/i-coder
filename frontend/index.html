<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor with AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #fff; height: 100vh; overflow: hidden; }
        
        .container { display: flex; height: 100vh; }
        .editor-panel { flex: 1; display: flex; flex-direction: column; }
        .toolbar { background: #2d2d30; padding: 10px; border-bottom: 1px solid #3e3e42; }
        .file-tabs { display: flex; gap: 5px; }
        .tab { background: #3c3c3c; padding: 8px 15px; border-radius: 4px 4px 0 0; cursor: pointer; border: 1px solid #555; }
        .tab.active { background: #1e1e1e; border-bottom: 1px solid #1e1e1e; }
        
        .editor-container { flex: 1; position: relative; }
        .CodeMirror { height: 100%; font-size: 14px; }
        
        .chat-toggle { position: fixed; bottom: 20px; right: 20px; background: #007acc; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; z-index: 1000; }
        
        .chat-panel { position: fixed; bottom: 0; right: 0; width: 400px; height: 0; background: #252526; border-left: 1px solid #3e3e42; transition: height 0.3s ease; overflow: hidden; z-index: 999; }
        .chat-panel.open { height: 60vh; }
        
        .chat-header { background: #2d2d30; padding: 10px; border-bottom: 1px solid #3e3e42; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; max-height: calc(60vh - 100px); }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .message.user { background: #0e639c; margin-left: 20px; }
        .message.ai { background: #1a1a1a; margin-right: 20px; }
        
        .chat-input { display: flex; padding: 10px; border-top: 1px solid #3e3e42; }
        .chat-input input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        .chat-input button { background: #007acc; color: white; border: none; padding: 8px 15px; margin-left: 5px; border-radius: 4px; cursor: pointer; }
        
        .file-explorer { width: 250px; background: #252526; border-right: 1px solid #3e3e42; padding: 10px; overflow-y: auto; }
        .file-item { padding: 5px; cursor: pointer; border-radius: 3px; }
        .file-item:hover { background: #2a2d2e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="file-explorer">
            <h3>Files</h3>
            <div id="fileList"></div>
            <button onclick="createFile()" style="margin-top: 10px; background: #007acc; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">New File</button>
        </div>
        
        <div class="editor-panel">
            <div class="toolbar">
                <div class="file-tabs" id="fileTabs"></div>
            </div>
            <div class="editor-container">
                <textarea id="editor"></textarea>
            </div>
        </div>
    </div>
    
    <button class="chat-toggle" onclick="toggleChat()">ðŸ’¬</button>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>AI Assistant (Codestral)</span>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer;">âœ•</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask AI to help with code..." onkeypress="handleChatKeypress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let editor;
        let currentFile = null;
        let files = {};
        
        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            lineNumbers: true,
            theme: 'default',
            mode: 'javascript',
            indentUnit: 2,
            tabSize: 2,
            indentWithTabs: false
        });
        
        // Chat functionality
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            panel.classList.toggle('open');
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        currentFile: currentFile,
                        fileContent: currentFile ? editor.getValue() : null,
                        files: Object.keys(files)
                    })
                });
                
                const result = await response.json();
                addMessage(result.response, 'ai');
                
                // Handle tool results
                if (result.fileUpdated) {
                    loadFile(result.fileUpdated);
                }
                if (result.filesChanged) {
                    loadFileList();
                }
            } catch (error) {
                addMessage('Error: ' + error.message, 'ai');
            }
        }
        
        function addMessage(text, type) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        // File management
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                displayFiles(data.files);
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }
        
        function displayFiles(fileList) {
            const container = document.getElementById('fileList');
            container.innerHTML = '';
            
            function renderFiles(files, indent = 0) {
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.style.paddingLeft = (indent * 15) + 'px';
                    div.textContent = file.name;
                    div.onclick = () => {
                        if (file.type === 'file') {
                            loadFile(file.path);
                        }
                    };
                    container.appendChild(div);
                    
                    if (file.children) {
                        renderFiles(file.children, indent + 1);
                    }
                });
            }
            
            renderFiles(fileList);
        }
        
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/api/files/${filePath}`);
                const data = await response.json();
                
                files[filePath] = data.content;
                currentFile = filePath;
                editor.setValue(data.content);
                
                // Update file mode based on extension
                const ext = filePath.split('.').pop();
                const mode = ext === 'py' ? 'python' : 'javascript';
                editor.setOption('mode', mode);
                
                updateTabs();
            } catch (error) {
                console.error('Error loading file:', error);
            }
        }
        
        async function saveFile() {
            if (!currentFile) return;
            
            const content = editor.getValue();
            files[currentFile] = content;
            
            try {
                await fetch('/api/files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filePath: currentFile, content })
                });
            } catch (error) {
                console.error('Error saving file:', error);
            }
        }
        
        function createFile() {
            const name = prompt('File name:');
            if (name) {
                files[name] = '';
                currentFile = name;
                editor.setValue('');
                updateTabs();
                saveFile();
                loadFileList();
            }
        }
        
        function updateTabs() {
            const container = document.getElementById('fileTabs');
            container.innerHTML = '';
            
            Object.keys(files).forEach(filePath => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (filePath === currentFile ? ' active' : '');
                tab.textContent = filePath.split('/').pop();
                tab.onclick = () => loadFile(filePath);
                container.appendChild(tab);
            });
        }
        
        // Auto-save on change
        editor.on('change', () => {
            if (currentFile) {
                files[currentFile] = editor.getValue();
                setTimeout(saveFile, 1000);
            }
        });
        
        // Initialize
        loadFileList();
    </script>
</body>
</html>